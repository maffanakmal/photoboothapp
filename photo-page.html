<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Photobooth — Final UI Fix</title>

    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <!-- <link rel="stylesheet" href="css/style.css"> -->
    <style>
        :root {
            --bg: #f7f9fc;
            --card: #fff;
            --muted: #98a0ad;
            --accent-grad: linear-gradient(90deg, #667eea, #764ba2);
            --radius: 14px;
            --soft-shadow: 0 10px 30px rgba(29, 39, 61, 0.06);
            --shutter: 84px;
            --gap: 18px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: Poppins, sans-serif;
            background: var(--bg);
            -webkit-font-smoothing: antialiased;
            color: #0f1724
        }

        .container-app {
            max-width: 1200px;
            margin: 28px auto;
            padding: 18px
        }

        .brand {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px
        }

        .brand-left {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .brand h1 {
            font-size: 18px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .brand p {
            margin: 0;
            color: var(--muted);
            font-size: 13px
        }

        /* Grid: default NO preview (camera full width) */
        .photobooth-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--gap);
            transition: all .24s ease
        }

        /* When preview visible, switch to two columns */
        .photobooth-grid.show-preview {
            grid-template-columns: 70% 30%
        }

        .card-wrap {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--soft-shadow);
            overflow: hidden;
            border: 1px solid rgba(15, 23, 36, 0.04)
        }

        /* LEFT camera */
        .camera-area {
            position: relative;
            background: #000;
            aspect-ratio: 16/9;
            min-height: 420px
        }

        video,
        img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block
        }

        #capturedPhoto {
            display: none
        }

        /* Start overlay */
        .start-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 6;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.02));
            pointer-events: none
        }

        .start-inner {
            pointer-events: all;
            text-align: center
        }

        .btn-primary-gradient {
            background: var(--accent-grad);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 999px;
            box-shadow: 0 6px 18px rgba(102, 126, 234, 0.18);
            font-weight: 600
        }

        /* Circular countdown (transparent) */
        .countdown {
            position: absolute;
            left: 50%;
            top: 48%;
            transform: translate(-50%, -50%);
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 170px;
            height: 170px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(6px);
            border: 2px solid rgba(255, 255, 255, 0.35);
            color: #fff;
            font-size: 3.6rem;
            font-weight: 800;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.45);
            opacity: 0;
            pointer-events: none;
            transform-origin: center center;
        }

        .countdown.show {
            opacity: 1;
            transition: opacity .12s ease
        }

        .countdown.pulse {
            animation: pulseScale .62s ease
        }

        @keyframes pulseScale {
            0% {
                transform: translate(-50%, -50%) scale(.92)
            }

            50% {
                transform: translate(-50%, -50%) scale(1.08)
            }

            100% {
                transform: translate(-50%, -50%) scale(.98)
            }
        }

        .flash {
            position: absolute;
            inset: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 40
        }

        .flash.show {
            animation: flashIn .28s ease
        }

        @keyframes flashIn {
            0% {
                opacity: 0
            }

            10% {
                opacity: .9
            }

            100% {
                opacity: 0
            }
        }

        /* Shutter centered in camera area */
        .shutter-wrap {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 18px;
            z-index: 20;
            display: flex;
            align-items: center;
            gap: 12px
        }

        .shutter-btn {
            width: var(--shutter);
            height: var(--shutter);
            border-radius: 50%;
            background: white;
            border: 6px solid rgba(15, 23, 36, 0.06);
            box-shadow: 0 12px 30px rgba(29, 39, 61, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer
        }

        .shutter-inner {
            width: 62px;
            height: 62px;
            border-radius: 50%;
            background: var(--accent-grad);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 700
        }

        .small-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 5px;

            border-radius: 50px;
            background: rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(6px);
            border: 2px solid rgba(255, 255, 255, 0.35);
            color: #fff;
        }

        .btn-round {
            border-radius: 999px;
            padding: 10px 14px
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(15, 23, 36, 0.06)
        }

        .btn-download {
            background: linear-gradient(90deg, #16a34a, #34d399);
            color: white;
            border: none
        }

        /* mirror + filters */
        video.mirror {
            transform: scaleX(-1)
        }

        img.mirror {
            transform: scaleX(-1)
        }

        /* RIGHT preview */
        .preview-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 14px;
            min-height: 420px;
            opacity: 0;
            transform: translateY(6px);
            transition: opacity .28s ease, transform .28s ease
        }

        .photobooth-grid.show-preview .preview-area {
            opacity: 1;
            transform: translateY(0)
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px
        }

        .preview-strip {
            background: #f8fafc;
            border-radius: 10px;
            padding: 10px;
            flex: 1;
            overflow: auto
        }

        .thumb {
            width: 100%;
            border-radius: 6px;
            object-fit: cover;
            display: block;
            margin-bottom: 10px;
            border: 1px solid rgba(0, 0, 0, 0.06)
        }

        .thumb-box {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center
        }

        .small-meta {
            font-size: 13px;
            color: var(--muted)
        }

        /* responsive */
        @media(max-width:900px) {
            .photobooth-grid {
                grid-template-columns: 1fr
            }

            .shutter-wrap {
                bottom: 12px
            }

            .camera-area {
                min-height: 300px
            }

            .preview-area {
                order: 2
            }
        }
    </style>
</head>

<body>
    <div class="container-app">
        <div class="brand">
            <div class="brand-left">
                <a href="index.html"><i class="fa-solid fa-camera" style="color:#667eea"></i> Photobooth</a>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <label class="small-meta mb-0 me-1">Photos</label>
                <select id="numSelect" class="form-select form-select-sm" style="width:80px">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3" selected>3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
            <div>
                <small class="small-meta">Press <strong>Space</strong> to start/capture · <strong>M</strong> mirror ·
                    <strong>S</strong> start/stop</small>
            </div>
        </div>

        <div id="photoboothGrid" class="photobooth-grid">
            <!-- CAMERA (left) -->
            <div class="card-wrap camera-area">
                <div style="position:relative;height:100%">
                    <div id="startOverlay" class="start-overlay">
                        <div class="start-inner">
                            <button id="startBtn" class="btn btn-primary-gradient btn-round">
                                <i class="fa-solid fa-camera me-2"></i><span id="startBtnText">Start Camera</span>
                                <span id="startSpinner" class="ms-2 spinner-border spinner-border-sm"
                                    style="display:none"></span>
                            </button>
                            <div style="margin-top:8px;color:var(--muted);font-size:13px">Allow camera permission</div>
                        </div>
                    </div>

                    <div id="countdown" class="countdown" aria-hidden="true">3</div>
                    <div id="flash" class="flash" aria-hidden="true"></div>

                    <video id="video" autoplay playsinline muted class="filter-none"></video>
                    <img id="capturedPhoto" alt="Captured photo" />

                    <div class="shutter-wrap" aria-hidden="false">
                        <div class="small-actions">
                            <button id="stopBtn" class="btn btn-ghost btn-round" title="Stop Camera"
                                style="display:none"><i class="fa-solid fa-stop"></i></button>
                        </div>

                        <div class="shutter-btn" id="shutterBtn" title="Capture">
                            <div class="shutter-inner" id="shutterInner"><i class="fa-solid fa-circle"></i></div>
                        </div>

                        <div class="small-actions">
                            <button id="mirrorBtn" class="btn btn-ghost btn-round" title="Mirror On/Off"
                                style="display: none;"><i class="fa-solid fa-arrows-rotate"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PREVIEW (right) -->
            <div class="card-wrap preview-area" id="previewArea" aria-live="polite">
                <div class="preview-header">
                    <div>
                        <div style="font-weight:600">Preview / Strip</div>
                        <div class="small-meta">Captured photos will appear here (vertical strip)</div>
                    </div>
                </div>

                <div class="preview-strip" id="previewStrip">
                    <div id="thumbContainer" style="display:flex;flex-direction:column;gap:12px;min-height:60px"></div>
                    <div id="stripNote" class="small-meta" style="margin-top:8px">After sequence completes, you can
                        download the strip or each image.</div>
                </div>

                <div style="display:flex;gap:10px;justify-content:flex-end;align-items:center;margin-top:6px">
                    <button id="downloadStripBtn" class="btn btn-download btn-round" disabled><i
                            class="fa-solid fa-download me-2"></i> Download Strip</button>
                    <button id="downloadAllBtn" class="btn btn-ghost btn-round" disabled><i
                            class="fa-solid fa-file-arrow-down me-2"></i> Download All</button>
                    <button id="clearBtn" class="btn btn-ghost btn-round" disabled><i
                            class="fa-solid fa-trash me-2"></i> Clear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- <script src="js/script.js"></script> -->
    <script>
        // Elements
        const photoboothGrid = document.getElementById('photoboothGrid');
        const startBtn = document.getElementById('startBtn');
        const startBtnText = document.getElementById('startBtnText');
        const startSpinner = document.getElementById('startSpinner');
        const startOverlay = document.getElementById('startOverlay');

        const video = document.getElementById('video');
        const capturedPhoto = document.getElementById('capturedPhoto');
        const countdownEl = document.getElementById('countdown');
        const flashEl = document.getElementById('flash');
        const shutterBtn = document.getElementById('shutterBtn');
        const stopBtn = document.getElementById('stopBtn');
        const mirrorBtn = document.getElementById('mirrorBtn');

        const numSelect = document.getElementById('numSelect');
        const thumbContainer = document.getElementById('thumbContainer');
        const previewArea = document.getElementById('previewArea');
        const downloadStripBtn = document.getElementById('downloadStripBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const clearBtn = document.getElementById('clearBtn');

        // offscreen canvas
        const offCanvas = document.createElement('canvas');

        // State
        let stream = null;
        let currentFilter = 'none';
        let isMirrored = false;
        let inSequence = false;
        let capturedData = []; // data URLs array

        const DELAY_MS = 3000; // 3 seconds (countdown is 3s)

        // Helpers
        function updatePreviewVisibility() {
            // Preview auto-hide until capturedData.length >= 3
            if (capturedData.length >= 1) {
                photoboothGrid.classList.add('show-preview');
            } else {
                photoboothGrid.classList.remove('show-preview');
            }
        }

        function setActiveFilterButton(name) {
            currentFilter = name;
        }
        function applyFilterToVideo(name) {
            video.classList.remove(...[...video.classList].filter(c => c.startsWith('filter-')));
            video.classList.add('filter-' + name);
            currentFilter = name;
        }

        async function startCamera() {
            if (stream) return;
            startSpinner.style.display = 'inline-block';
            startBtnText.textContent = 'Starting…';
            startBtn.disabled = true;
            try {
                const media = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' }, audio: false });
                stream = media; video.srcObject = stream;
                await new Promise(r => {
                    if (video.readyState >= 2) return r();
                    video.onloadedmetadata = () => r();
                });
                startOverlay.style.display = 'none';
                stopBtn.style.display = 'inline-flex';
                mirrorBtn.style.display = 'inline-flex';
                if (isMirrored) video.classList.add('mirror'); else video.classList.remove('mirror');
                video.muted = true;
            } catch (err) {
                console.error('Camera error', err);
                alert('Unable to access camera. Please allow camera permission and try again.');
            } finally {
                startSpinner.style.display = 'none';
                startBtnText.textContent = 'Start Camera';
                startBtn.disabled = false;
            }
        }

        function stopCamera() {
            if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
            video.srcObject = null;
            startOverlay.style.display = 'flex';
            stopBtn.style.display = 'none';
            mirrorBtn.style.display = 'none';
            // keep preview intact
        }

        function flash() {
            flashEl.classList.add('show');
            setTimeout(() => flashEl.classList.remove('show'), 260);
        }

        function captureOnce() {
            if (!stream) return null;
            const vw = video.videoWidth || video.clientWidth || 1280;
            const vh = video.videoHeight || video.clientHeight || Math.round(vw * 9 / 16);
            offCanvas.width = vw; offCanvas.height = vh;
            const ctx = offCanvas.getContext('2d');
            const computed = getComputedStyle(video).filter || 'none';
            ctx.filter = computed;
            if (isMirrored) {
                ctx.save();
                ctx.translate(offCanvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, offCanvas.width, offCanvas.height);
                ctx.restore();
            } else {
                ctx.drawImage(video, 0, 0, offCanvas.width, offCanvas.height);
            }
            return offCanvas.toDataURL('image/png');
        }

        async function runCountdown() {
            countdownEl.classList.add('show');
            for (let i = 3; i > 0; i--) {
                countdownEl.textContent = i;
                countdownEl.classList.add('pulse');
                await new Promise(r => setTimeout(r, 620));
                countdownEl.classList.remove('pulse');
                await new Promise(r => setTimeout(r, 380));
            }
            countdownEl.classList.remove('show');
            await new Promise(r => setTimeout(r, 80));
        }

        async function createVerticalStripFromData(dataUrls) {
            if (!dataUrls || dataUrls.length === 0) return null;
            const imgs = await Promise.all(dataUrls.map(d => new Promise((res) => {
                const i = new Image(); i.onload = () => res(i); i.onerror = () => res(null); i.src = d;
            })));
            const validImgs = imgs.filter(i => i !== null);
            if (validImgs.length === 0) return null;
            const widths = validImgs.map(i => i.width);
            const targetWidth = Math.max(...widths);
            const heights = validImgs.map(i => Math.round(i.height * (targetWidth / i.width)));
            const totalHeight = heights.reduce((a, b) => a + b, 0);
            const stripCanvas = document.createElement('canvas');
            stripCanvas.width = targetWidth;
            stripCanvas.height = totalHeight;
            const ctx = stripCanvas.getContext('2d');
            let y = 0;
            for (let idx = 0; idx < validImgs.length; idx++) {
                const img = validImgs[idx];
                const h = heights[idx];
                ctx.drawImage(img, 0, y, targetWidth, h);
                y += h;
            }
            return stripCanvas.toDataURL('image/png');
        }

        function refreshThumbs() {
            thumbContainer.innerHTML = '';
            capturedData.forEach((d, idx) => {
                const box = document.createElement('div');
                box.className = 'thumb-box';
                const img = document.createElement('img');
                img.src = d;
                img.className = 'thumb';
                if (isMirrored) img.classList.add('mirror'); else img.classList.remove('mirror');
                box.appendChild(img);
                const lbl = document.createElement('div');
                lbl.className = 'small-meta';
                lbl.style.width = '100%';
                lbl.style.textAlign = 'center';
                lbl.textContent = `Photo #${idx + 1}`;
                const actions = document.createElement('div');
                actions.style.display = 'flex'; actions.style.gap = '8px'; actions.style.marginTop = '6px';
                const dl = document.createElement('button');
                dl.className = 'btn btn-ghost btn-round btn-sm'; dl.innerHTML = '<i class="fa-solid fa-download"></i>';
                dl.title = 'Download this photo';
                dl.onclick = () => triggerDownload(d, `photo-${idx + 1}.png`);
                const del = document.createElement('button');
                del.className = 'btn btn-ghost btn-round btn-sm text-danger'; del.innerHTML = '<i class="fa-solid fa-trash"></i>';
                del.title = 'Remove this photo';
                del.onclick = () => {
                    capturedData.splice(idx, 1);
                    refreshThumbs();
                    toggleActions();
                    updatePreviewVisibility();
                };
                actions.appendChild(dl); actions.appendChild(del);
                box.appendChild(lbl);
                box.appendChild(actions);
                thumbContainer.appendChild(box);
            });
            toggleActions();
        }

        function toggleActions() {
            const has = capturedData.length > 0;
            downloadStripBtn.disabled = !has;
            downloadAllBtn.disabled = !has;
            clearBtn.disabled = !has;
        }

        function triggerDownload(dataUrl, filename) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        async function captureSequence(n) {
            if (inSequence || !stream) return;
            inSequence = true;
            capturedData = [];
            refreshThumbs();
            updatePreviewVisibility();

            for (let i = 0; i < n; i++) {
                await runCountdown();
                flash();
                const data = captureOnce();
                if (data) {
                    capturedData.push(data);
                    refreshThumbs();
                }
                // no extra wait: countdown itself is 3s
            }

            // After sequence done, ensure preview visibility update
            updatePreviewVisibility();
            // Optionally create strip to show top or allow download; we'll keep thumbnails updated
            inSequence = false;
        }

        // UI events
        startBtn.addEventListener('click', startCamera);
        stopBtn.addEventListener('click', stopCamera);
        mirrorBtn.addEventListener('click', () => {
            isMirrored = !isMirrored;
            if (isMirrored) video.classList.add('mirror'); else video.classList.remove('mirror');
            refreshThumbs();
        });

        shutterBtn.addEventListener('click', async () => {
            if (!stream) {
                await startCamera();
                return;
            }
            if (inSequence) return;
            const n = Math.max(1, Math.min(12, parseInt(numSelect.value || '3', 10)));
            shutterBtn.style.pointerEvents = 'none';
            shutterBtn.style.opacity = '0.85';
            await captureSequence(n);
            shutterBtn.style.pointerEvents = 'auto';
            shutterBtn.style.opacity = '1';
        });

        // keyboard shortcuts
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                if (document.activeElement && /input|textarea|select/i.test(document.activeElement.tagName)) return;
                e.preventDefault();
                shutterBtn.click();
            }
            if (e.key === 's' || e.key === 'S') {
                if (!stream) startCamera(); else stopCamera();
            }
            if (e.key === 'm' || e.key === 'M') {
                mirrorBtn.click();
            }
        });

        // downloads and clear handlers
        downloadAllBtn.addEventListener('click', () => {
            capturedData.forEach((d, idx) => triggerDownload(d, `photo-${idx + 1}.png`));
        });
        downloadStripBtn.addEventListener('click', async () => {
            const s = await createVerticalStripFromData(capturedData);
            if (s) triggerDownload(s, `photostrip-${Date.now()}.png`);
        });
        clearBtn.addEventListener('click', () => {
            capturedData = [];
            thumbContainer.innerHTML = '';
            toggleActions();
            updatePreviewVisibility();
        });

        // cleanup
        window.addEventListener('beforeunload', () => { if (stream) stream.getTracks().forEach(t => t.stop()); });

        // initial
        updatePreviewVisibility();
        toggleActions();

        function triggerDownload(dataUrl, filename) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Clear all captured photos
        function clearAll() {
            capturedData = [];
            refreshThumbs();
            updatePreviewVisibility();
        }

        // Download all photos one by one
        function downloadAllPhotos() {
            capturedData.forEach((d, i) => {
                triggerDownload(d, `photo-${i + 1}.png`);
            });
        }

        // Download vertical strip
        async function downloadStrip() {
            const strip = await createVerticalStripFromData(capturedData);
            if (!strip) return;
            triggerDownload(strip, 'photobooth-strip.png');
        }

        // Capture sequence
        async function captureSequence() {
            if (inSequence) return;
            inSequence = true;

            const total = parseInt(numSelect.value, 10) || 3;

            for (let i = 0; i < total; i++) {
                await runCountdown();
                flash();
                const data = captureOnce();
                if (data) capturedData.push(data);
                refreshThumbs();
                updatePreviewVisibility();
                if (i < total - 1) await new Promise(r => setTimeout(r, 350));
            }

            inSequence = false;
        }

        // Toggle mirror
        function toggleMirror() {
            isMirrored = !isMirrored;
            if (isMirrored) video.classList.add('mirror');
            else video.classList.remove('mirror');
            refreshThumbs();
        }

        // EVENTS
        startBtn.onclick = startCamera;
        stopBtn.onclick = stopCamera;
        mirrorBtn.onclick = toggleMirror;

        shutterBtn.onclick = () => {
            if (!stream) return startCamera();
            captureSequence();
        };

        clearBtn.onclick = clearAll;
        downloadAllBtn.onclick = downloadAllPhotos;
        downloadStripBtn.onclick = downloadStrip;

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (!stream) startCamera();
                else shutterBtn.click();
            }
            if (e.key.toLowerCase() === 'm') {
                if (stream) toggleMirror();
            }
            if (e.key.toLowerCase() === 's') {
                if (stream) stopCamera();
                else startCamera();
            }
        });

    </script>
</body>

</html>