<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>apxbooth</title>

    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --bg: #f7f9fc;
            --card: #fff;
            --muted: #98a0ad;
            --accent-grad: linear-gradient(90deg, #667eea, #764ba2);
            --radius: 14px;
            --soft-shadow: 0 10px 30px rgba(29, 39, 61, 0.06);
            --shutter: 84px;
            --gap: 18px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: Poppins, sans-serif;
            background: var(--bg);
            -webkit-font-smoothing: antialiased;
            color: #0f1724
        }

        .container-app {
            max-width: 1200px;
            margin: 28px auto;
            padding: 18px
        }

        .brand {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px
        }

        .brand-left {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .brand h1 {
            font-size: 18px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .brand p {
            margin: 0;
            color: var(--muted);
            font-size: 13px
        }

        .photobooth-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--gap);
            transition: all .24s ease
        }

        .photobooth-grid.show-preview {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto;
        }

        .card-wrap {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--soft-shadow);
            overflow: hidden;
            border: 1px solid rgba(15, 23, 36, 0.04)
        }

        .camera-area {
            position: relative;
            background: #000;
            aspect-ratio: 16/9;
            min-height: 420px
        }

        video,
        img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block
        }

        #capturedPhoto {
            display: none
        }

        .start-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 6;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.02));
            pointer-events: none
        }

        .start-inner {
            pointer-events: all;
            text-align: center
        }

        .btn-primary-gradient {
            background: var(--accent-grad);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 999px;
            box-shadow: 0 6px 18px rgba(102, 126, 234, 0.18);
            font-weight: 600
        }

        .countdown {
            position: absolute;
            left: 50%;
            top: 48%;
            transform: translate(-50%, -50%);
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 170px;
            height: 170px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(6px);
            border: 2px solid rgba(255, 255, 255, 0.35);
            color: #fff;
            font-size: 3.6rem;
            font-weight: 800;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.45);
            opacity: 0;
            pointer-events: none;
            transform-origin: center center;
        }

        .countdown.show {
            opacity: 1;
            transition: opacity .12s ease
        }

        .countdown.pulse {
            animation: pulseScale .62s ease
        }

        @keyframes pulseScale {
            0% {
                transform: translate(-50%, -50%) scale(.92)
            }

            50% {
                transform: translate(-50%, -50%) scale(1.08)
            }

            100% {
                transform: translate(-50%, -50%) scale(.98)
            }
        }

        .flash {
            position: absolute;
            inset: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 40
        }

        .flash.show {
            animation: flashIn .28s ease
        }

        @keyframes flashIn {
            0% {
                opacity: 0
            }

            10% {
                opacity: .9
            }

            100% {
                opacity: 0
            }
        }

        .shutter-wrap {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 18px;
            z-index: 20;
            display: flex;
            align-items: center;
            gap: 12px
        }

        .shutter-btn {
            width: var(--shutter);
            height: var(--shutter);
            border-radius: 50%;
            background: white;
            border: 6px solid rgba(15, 23, 36, 0.06);
            box-shadow: 0 12px 30px rgba(29, 39, 61, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer
        }

        .shutter-inner {
            width: 62px;
            height: 62px;
            border-radius: 50%;
            background: var(--accent-grad);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 700
        }

        .small-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 5px;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(6px);
            border: 2px solid rgba(255, 255, 255, 0.35);
            color: #fff;
        }

        .btn-round {
            border-radius: 999px;
            padding: 10px 14px
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(15, 23, 36, 0.06)
        }

        .btn-download {
            background: linear-gradient(90deg, #16a34a, #34d399);
            color: white;
            border: none
        }

        video.mirror {
            transform: scaleX(-1)
        }

        img.mirror {
            transform: scaleX(-1)
        }

        /* Photo Filters */
        .filter-none {
            filter: none;
        }

        .filter-grayscale {
            filter: grayscale(100%);
        }

        .filter-sepia {
            filter: sepia(80%);
        }

        .filter-vintage {
            filter: sepia(50%) contrast(1.2) brightness(0.9);
        }

        .filter-warm {
            filter: saturate(1.4) hue-rotate(-10deg) brightness(1.1);
        }

        .filter-cool {
            filter: saturate(1.2) hue-rotate(10deg) brightness(1.05);
        }

        .filter-dramatic {
            filter: contrast(1.5) brightness(0.95) saturate(1.3);
        }

        .filter-fade {
            filter: brightness(1.1) contrast(0.85) saturate(0.8);
        }

        .filter-noir {
            filter: grayscale(100%) contrast(1.3) brightness(0.9);
        }

        .preview-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 14px;
            min-height: 420px;
            opacity: 0;
            order: 2;
            transform: translateY(6px);
            transition: opacity .28s ease, transform .28s ease
        }

        .preview-row {
            display: grid;
            grid-template-columns: 1fr 260px;
            gap: 14px;
        }

        .photobooth-grid.show-preview .preview-area {
            opacity: 1;
            transform: translateY(0)
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px
        }

        .preview-strip {
            background: #f8fafc;
            border-radius: 10px;
            padding: 10px;
            flex: 1;
            overflow: auto
        }

        .thumb {
            width: 100%;
            border-radius: 6px;
            object-fit: cover;
            display: block;
            margin-bottom: 10px;
            border: 1px solid rgba(0, 0, 0, 0.06)
        }

        .thumb-box {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center
        }

        .small-meta {
            font-size: 13px;
            color: var(--muted)
        }

        @media(max-width:900px) {
            .photobooth-grid {
                grid-template-columns: 1fr
            }

            .shutter-wrap {
                bottom: 12px
            }

            .camera-area {
                min-height: 300px
            }

            .preview-area {
                order: 2
            }
        }

        .frame-preview {
            background: #f4f6fb;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 280px;
        }

        #frameBox {
            width: 180px;
            height: 260px;
            background: white;
            border: 10px solid var(--accent-grad);
            border-color: var(--frame-color, #667eea);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            border-radius: 8px;
            position: relative;
        }

        #frameTextPreview {
            width: 100%;
            text-align: center;
            padding: 6px;
            font-size: 14px;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.7);
            font-family: var(--frame-font, Poppins);
        }

        #framePhotoContainer {
            position: absolute;
            top: 10px;
            bottom: 40px;
            left: 10px;
            right: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            gap: 6px;
        }

        .frame-photo-item {
            width: 100%;
            height: calc((100% - 18px) / 3);
            /* auto adjusts based on 3 photos */
            object-fit: cover;
            border-radius: 4px;
        }

        #stickerLayer {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .sticker {
            width: 50px;
            height: 50px;
            position: absolute;
            cursor: move;
            pointer-events: auto;
        }


        .sticker-toolbar {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .emoji-btn {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            font-size: 18px;
            cursor: pointer;
        }


        @media(max-width:900px) {
            .preview-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- QRIS Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Payment Required</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body text-center">
                    <p><strong>Scan QRIS to Download</strong></p>
                    <p>Order ID: <span id="orderId"></span></p>

                    <!-- Your Static QRIS Image -->
                    <img src="img/qris.jpg" alt="QRIS Code" class="img-fluid rounded shadow p-2 mb-3">

                    <p>After payment, click the button below:</p>
                </div>

                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmPaymentButton" class="btn btn-primary">I Have Paid</button>
                </div>

            </div>
        </div>
    </div>

    <div class="container-app">
        <div class="brand">
            <div class="brand-left">
                <a href="index.html" style="text-decoration: none;"><i class="fa-solid fa-camera"
                        style="color:#667eea"></i> apxbooth</a>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <label class="small-meta mb-0 me-1">Photos</label>
                <select id="numSelect" class="form-select form-select-sm" style="width:80px">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3" selected>3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <label class="small-meta mb-0 me-1">Filter</label>
                <select id="filterSelect" class="form-select form-select-sm" style="width:120px">
                    <option value="none" selected>None</option>
                    <option value="grayscale">Grayscale</option>
                    <option value="sepia">Sepia</option>
                    <option value="vintage">Vintage</option>
                    <option value="warm">Warm</option>
                    <option value="cool">Cool</option>
                    <option value="dramatic">Dramatic</option>
                    <option value="fade">Fade</option>
                    <option value="noir">Noir</option>
                </select>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <label class="small-meta mb-0 me-1">Frame Color</label>
                <input type="color" id="frameColorPicker" class="form-control form-control-color" value="#667eea"
                    style="width:50px;height:32px">
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <input type="text" id="frameText" class="form-control form-control-sm" placeholder="Event name..."
                    style="width:150px">
                <select id="fontSelect" class="form-select form-select-sm" style="width:120px">
                    <option value="font" selected>Font</option>
                    <option value="Poppins">Poppins</option>
                    <option value="Arial">Arial</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Times New Roman">Times</option>
                    <option value="Courier New">Courier</option>
                    <option value="Comic Sans MS">Comic Sans</option>
                    <option value="Impact">Impact</option>
                    <option value="Verdana">Verdana</option>
                </select>
            </div>
            <!-- <div>
                <small class="small-meta">Press <strong>Space</strong> to start/capture Â· <strong>M</strong> mirror Â·
                    <strong>S</strong> start/stop</small>
            </div> -->
        </div>

        <div id="photoboothGrid" class="photobooth-grid">
            <!-- CAMERA (left) -->
            <div class="card-wrap camera-area">
                <div style="position:relative;height:100%">
                    <div id="startOverlay" class="start-overlay">
                        <div class="start-inner">
                            <button id="startBtn" class="btn btn-primary-gradient btn-round">
                                <i class="fa-solid fa-camera me-2"></i><span id="startBtnText">Start Camera</span>
                                <span id="startSpinner" class="ms-2 spinner-border spinner-border-sm"
                                    style="display:none"></span>
                            </button>
                            <div style="margin-top:8px;color:var(--muted);font-size:13px">Allow camera permission</div>
                        </div>
                    </div>

                    <div id="countdown" class="countdown" aria-hidden="true">3</div>
                    <div id="flash" class="flash" aria-hidden="true"></div>

                    <video id="video" autoplay playsinline muted class="filter-none"></video>
                    <img id="capturedPhoto" alt="Captured photo" />

                    <div class="shutter-wrap" aria-hidden="false">
                        <div class="small-actions">
                            <button id="stopBtn" class="btn btn-ghost btn-round" title="Stop Camera"
                                style="display:none"><i class="fa-solid fa-stop"></i></button>
                        </div>

                        <div class="shutter-btn" id="shutterBtn" title="Capture">
                            <div class="shutter-inner" id="shutterInner"><i class="fa-solid fa-circle"></i></div>
                        </div>

                        <div class="small-actions">
                            <button id="mirrorBtn" class="btn btn-ghost btn-round" title="Mirror On/Off"
                                style="display: none;"><i class="fa-solid fa-arrows-rotate"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PREVIEW (right) -->
            <div class="preview-area" id="previewArea">
                <div class="preview-header">
                    <div>
                        <div style="font-weight:600">Preview</div>
                        <div class="small-meta">Captured photos will appear here</div>
                    </div>
                </div>
                <div class="preview-row">
                    <!-- LEFT: PHOTO STRIP -->
                    <div class="preview-strip" id="previewStrip">
                        <div id="thumbContainer" style="display:flex;flex-direction:column;gap:12px;min-height:60px">
                        </div>
                        <div id="stripNote" class="small-meta" style="margin-top:8px">
                            After sequence completes, you can download the strip.
                        </div>
                    </div>

                    <!-- RIGHT: LIVE FRAME PREVIEW -->
                    <div class="frame-preview" id="framePreview">
                        <div id="frameBox">
                            <div id="framePhotoContainer"></div>
                            <div id="stickerLayer"></div>
                            <div id="frameTextPreview">Event Name</div>
                        </div>
                    </div>
                </div>

                <div style="display:flex;gap:10px;justify-content:flex-end;align-items:center;margin-top:6px">
                    <button id="downloadStripBtn" class="btn btn-download btn-round" disabled>
                        <i class="fa-solid fa-download me-2"></i> Download Strip
                    </button>
                    <button id="clearBtn" class="btn btn-ghost btn-round" disabled>
                        <i class="fa-solid fa-trash me-2"></i> Clear All
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Elements (safe queries - will create missing pieces if needed)
        const photoboothGrid = document.getElementById('photoboothGrid');
        const startBtn = document.getElementById('startBtn');
        const startBtnText = document.getElementById('startBtnText');
        const startSpinner = document.getElementById('startSpinner');
        const startOverlay = document.getElementById('startOverlay');

        const video = document.getElementById('video');
        const capturedPhoto = document.getElementById('capturedPhoto');
        const countdownEl = document.getElementById('countdown');
        const flashEl = document.getElementById('flash');
        const shutterBtn = document.getElementById('shutterBtn');
        const stopBtn = document.getElementById('stopBtn');
        const mirrorBtn = document.getElementById('mirrorBtn');

        const numSelect = document.getElementById('numSelect');
        const thumbContainer = document.getElementById('thumbContainer');
        const previewArea = document.getElementById('previewArea');
        const downloadStripBtn = document.getElementById('downloadStripBtn');
        const clearBtn = document.getElementById('clearBtn');

        const frameColorPicker = document.getElementById('frameColorPicker');
        const frameText = document.getElementById('frameText');
        const filterSelect = document.getElementById('filterSelect');
        const fontSelect = document.getElementById('fontSelect');

        const frameBox = document.getElementById('frameBox');
        const frameTextPreview = document.getElementById('frameTextPreview');

        let capturedPhotos = [];

        // Create a live photo preview image inside frameBox if it's missing
        let framePhotoPreview = document.getElementById('framePhotoPreview');
        if (!framePhotoPreview) {
            if (frameBox) {
                framePhotoPreview = document.createElement('img');
                framePhotoPreview.id = 'framePhotoPreview';
                framePhotoPreview.style.position = 'absolute';
                framePhotoPreview.style.inset = '12px 12px 48px 12px'; // leave space for header/footer
                framePhotoPreview.style.width = 'calc(100% - 24px)';
                framePhotoPreview.style.height = 'calc(100% - 60px)';
                framePhotoPreview.style.objectFit = 'cover';
                framePhotoPreview.style.display = 'none';
                framePhotoPreview.style.borderRadius = '6px';
                frameBox.appendChild(framePhotoPreview);
            } else {
                // fallback: create in body so code won't crash (rare)
                framePhotoPreview = document.createElement('img');
                framePhotoPreview.id = 'framePhotoPreview';
                framePhotoPreview.style.display = 'none';
                document.body.appendChild(framePhotoPreview);
            }
        }

        // Create a sticker panel (toolbar) next to preview if missing
        let stickerPanel = document.getElementById('stickerPanel');
        if (!stickerPanel) {
            // prefer to append to previewArea or frameBox
            const container = previewArea || frameBox || document.body;
            stickerPanel = document.createElement('div');
            stickerPanel.id = 'stickerPanel';
            stickerPanel.className = 'sticker-toolbar';
            stickerPanel.style.display = 'flex';
            stickerPanel.style.gap = '6px';
            stickerPanel.style.marginTop = '8px';

            // default emojis
            const EMOJI_SET = ['ðŸ˜€', 'ðŸ˜', 'ðŸŽ‰', 'ðŸ’–', 'ðŸ˜Ž', 'ðŸ¤©', 'ðŸ˜Š', 'ðŸ¥°', 'ðŸ˜‡', 'ðŸ¥º', 'ðŸ»', 'ðŸ°', 'ðŸ“', 'ðŸ•', 'ðŸŒ®', 'â˜€ï¸', 'ðŸŒˆ', 'ðŸ¦‹'];
            EMOJI_SET.forEach(e => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'emoji-btn';
                btn.textContent = e;
                btn.style.width = '36px';
                btn.style.height = '36px';
                btn.style.borderRadius = '6px';
                btn.style.fontSize = '18px';
                btn.style.cursor = 'pointer';
                stickerPanel.appendChild(btn);
            });

            // place stickerPanel into previewStrip area if possible
            if (previewArea) {
                // insert at top of previewArea
                previewArea.insertBefore(stickerPanel, previewArea.firstChild);
            } else if (frameBox) {
                frameBox.appendChild(stickerPanel);
            } else {
                document.body.appendChild(stickerPanel);
            }
        }

        // Create sticker layer container if not present (stickers live inside frameBox)
        let stickerLayer = document.getElementById('stickerLayer');
        if (!stickerLayer) {
            if (frameBox) {
                stickerLayer = document.createElement('div');
                stickerLayer.id = 'stickerLayer';
                stickerLayer.style.position = 'absolute';
                stickerLayer.style.inset = '0';
                stickerLayer.style.pointerEvents = 'none'; // individual stickers will allow pointer events
                frameBox.appendChild(stickerLayer);
            } else {
                stickerLayer = document.createElement('div');
                stickerLayer.id = 'stickerLayer';
                document.body.appendChild(stickerLayer);
            }
        }

        // offscreen canvas
        const offCanvas = document.createElement('canvas');

        // State
        let stream = null;
        let currentFilter = 'none';
        let isMirrored = false;
        let inSequence = false;
        let capturedData = [];
        let frameColor = (frameColorPicker && frameColorPicker.value) ? frameColorPicker.value : '#667eea';
        let frameTextValue = '';
        let selectedFont = (fontSelect && fontSelect.value) ? fontSelect.value : 'Poppins';

        const DELAY_MS = 3000;

        // Helpers
        function updatePreviewVisibility() {
            if (capturedData.length >= 1) {
                photoboothGrid && photoboothGrid.classList.add('show-preview');
            } else {
                photoboothGrid && photoboothGrid.classList.remove('show-preview');
            }
        }

        function setActiveFilterButton(name) {
            currentFilter = name;
            if (!video) return;
            video.classList.remove('filter-none', 'filter-grayscale', 'filter-sepia', 'filter-vintage',
                'filter-warm', 'filter-cool', 'filter-dramatic', 'filter-fade', 'filter-noir');
            video.classList.add('filter-' + name);
        }

        function applyFilterToVideo(name) {
            if (!video) return;
            video.classList.remove('filter-none', 'filter-grayscale', 'filter-sepia', 'filter-vintage',
                'filter-warm', 'filter-cool', 'filter-dramatic', 'filter-fade', 'filter-noir');
            video.classList.add('filter-' + name);
            currentFilter = name;
        }

        async function startCamera() {
            if (stream) return;
            if (startSpinner) startSpinner.style.display = 'inline-block';
            if (startBtnText) startBtnText.textContent = 'Startingâ€¦';
            if (startBtn) startBtn.disabled = true;
            try {
                const media = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' }, audio: false });
                stream = media; if (video) video.srcObject = stream;
                await new Promise(r => {
                    if (!video) return r();
                    if (video.readyState >= 2) return r();
                    video.onloadedmetadata = () => r();
                });
                if (startOverlay) startOverlay.style.display = 'none';
                if (stopBtn) stopBtn.style.display = 'inline-flex';
                if (mirrorBtn) mirrorBtn.style.display = 'inline-flex';
                if (isMirrored && video) video.classList.add('mirror'); else if (video) video.classList.remove('mirror');
                if (video) video.muted = true;
            } catch (err) {
                console.error('Camera error', err);
                try { alert('Unable to access camera. Please allow camera permission and try again.'); } catch (e) { }
            } finally {
                if (startSpinner) startSpinner.style.display = 'none';
                if (startBtnText) startBtnText.textContent = 'Start Camera';
                if (startBtn) startBtn.disabled = false;
            }
        }

        video.addEventListener('playing', () => {
            framePhotoPreview.style.display = 'block';
            function drawLive() {
                if (!stream) return;
                framePhotoPreview.srcObject = stream;
                requestAnimationFrame(drawLive);
            }
            drawLive();
        });


        function stopCamera() {
            if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
            if (video) video.srcObject = null;
            if (startOverlay) startOverlay.style.display = 'flex';
            if (stopBtn) stopBtn.style.display = 'none';
            if (mirrorBtn) mirrorBtn.style.display = 'none';

            if (numSelect) numSelect.value = '3';
            if (filterSelect) filterSelect.value = 'none';
            if (frameColorPicker) frameColorPicker.value = '#667eea';
            if (frameText) frameText.value = '';
        }

        function flash() {
            if (!flashEl) return;
            flashEl.classList.add('show');
            setTimeout(() => flashEl.classList.remove('show'), 260);
        }

        function captureOnce() {
            if (!stream || !video) return null;
            const vw = video.videoWidth || video.clientWidth || 1280;
            const vh = video.videoHeight || video.clientHeight || Math.round(vw * 9 / 16);
            offCanvas.width = vw; offCanvas.height = vh;
            const ctx = offCanvas.getContext('2d');
            const computed = getComputedStyle(video).filter || 'none';
            ctx.filter = computed;
            if (isMirrored) {
                ctx.save();
                ctx.translate(offCanvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, offCanvas.width, offCanvas.height);
                ctx.restore();
            } else {
                ctx.drawImage(video, 0, 0, offCanvas.width, offCanvas.height);
            }
            return offCanvas.toDataURL('image/png');
        }

        async function runCountdown() {
            if (!countdownEl) return;
            countdownEl.classList.add('show');
            for (let i = 3; i > 0; i--) {
                countdownEl.textContent = i;
                countdownEl.classList.add('pulse');
                await new Promise(r => setTimeout(r, 620));
                countdownEl.classList.remove('pulse');
                await new Promise(r => setTimeout(r, 380));
            }
            countdownEl.classList.remove('show');
            await new Promise(r => setTimeout(r, 80));
        }

        async function createVerticalStripFromData(dataUrls) {
            if (!dataUrls || dataUrls.length === 0) return null;
            const imgs = await Promise.all(dataUrls.map(d => new Promise((res) => {
                const i = new Image(); i.onload = () => res(i); i.onerror = () => res(null); i.src = d;
            })));
            const validImgs = imgs.filter(i => i !== null);
            if (validImgs.length === 0) return null;

            // Frame settings
            const framePadding = 40;
            const frameTopHeight = 120;
            const frameBottomHeight = 80;
            const photoSpacing = 20;

            const widths = validImgs.map(i => i.width);
            const targetWidth = Math.max(...widths);
            const contentWidth = targetWidth + (framePadding * 2);
            const heights = validImgs.map(i => Math.round(i.height * (targetWidth / i.width)));
            const totalPhotoHeight = heights.reduce((a, b) => a + b, 0);
            const totalSpacing = (validImgs.length - 1) * photoSpacing;
            const totalHeight = frameTopHeight + totalPhotoHeight + totalSpacing + frameBottomHeight;

            const stripCanvas = document.createElement('canvas');
            stripCanvas.width = contentWidth;
            stripCanvas.height = totalHeight;
            const ctx = stripCanvas.getContext('2d');

            // Draw frame background
            ctx.fillStyle = frameColor;
            ctx.fillRect(0, 0, contentWidth, totalHeight);

            // Draw header text if provided
            if (frameTextValue.trim()) {
                ctx.fillStyle = '#ffffff';
                ctx.font = `bold 32px ${selectedFont}, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(frameTextValue.trim(), contentWidth / 2, frameTopHeight / 2);
            }

            // Draw photos with white border
            // Draw photos with white border + STICKERS
            let y = frameTopHeight;
            for (let idx = 0; idx < validImgs.length; idx++) {
                const img = validImgs[idx];
                const h = heights[idx];

                // White border
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(framePadding - 5, y - 5, targetWidth + 10, h + 10);

                // Draw photo
                ctx.drawImage(img, framePadding, y, targetWidth, h);

                // --- Draw stickers on top of this photo ---
                const stickers = [...frameBox.querySelectorAll('.sticker')];
                stickers.forEach(st => {
                    const rect = st.getBoundingClientRect();
                    const fb = frameBox.getBoundingClientRect();
                    const relX = (rect.left - fb.left) / fb.width;
                    const relY = (rect.top - fb.top) / fb.height;
                    const scale = parseFloat(st.style.transform.replace(/[^0-9.]/g, "")) || 1;
                    const fontSize = parseFloat(st.style.fontSize) * scale * (targetWidth / fb.width);

                    ctx.font = `${fontSize}px sans-serif`;
                    ctx.fillText(st.textContent,
                        framePadding + relX * targetWidth,
                        y + relY * h
                    );
                });
                // -----------------------------------------

                y += h + photoSpacing;
            }


            // Draw footer with timestamp
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            ctx.fillStyle = '#ffffff';
            ctx.font = `18px ${selectedFont}, sans-serif`;
            ctx.textAlign = 'center';
            ctx.fillText(`${dateStr} â€¢ ${timeStr}`, contentWidth / 2, totalHeight - (frameBottomHeight / 2));

            return stripCanvas.toDataURL('image/png');
        }

        function refreshThumbs() {
            if (!thumbContainer) return;
            thumbContainer.innerHTML = '';
            capturedData.forEach((d, idx) => {
                const box = document.createElement('div');
                box.className = 'thumb-box';
                const img = document.createElement('img');
                img.src = d;
                img.className = 'thumb';
                if (isMirrored) img.classList.add('mirror'); else img.classList.remove('mirror');
                box.appendChild(img);
                const lbl = document.createElement('div');
                lbl.className = 'small-meta';
                lbl.style.width = '100%';
                lbl.style.textAlign = 'center';
                lbl.textContent = `Photo #${idx + 1}`;
                const actions = document.createElement('div');
                actions.style.display = 'flex'; actions.style.gap = '8px'; actions.style.marginTop = '6px';
                const dl = document.createElement('button');
                dl.className = 'btn btn-ghost btn-round btn-sm'; dl.innerHTML = '<i class="fa-solid fa-download"></i>';
                dl.title = 'Download this photo';
                dl.onclick = () => triggerDownload(d, `photo-${idx + 1}.png`);
                const del = document.createElement('button');
                del.className = 'btn btn-ghost btn-round btn-sm text-danger'; del.innerHTML = '<i class="fa-solid fa-trash"></i>';
                del.title = 'Remove this photo';
                del.onclick = () => {
                    capturedData.splice(idx, 1);
                    refreshThumbs();
                    toggleActions();
                    updatePreviewVisibility();
                    refreshPreviewFrame();
                };
                actions.appendChild(dl); actions.appendChild(del);
                box.appendChild(lbl);
                box.appendChild(actions);
                thumbContainer.appendChild(box);
            });
            toggleActions();
        }

        function toggleActions() {
            const has = capturedData.length > 0;
            if (downloadStripBtn) downloadStripBtn.disabled = !has;
            if (clearBtn) clearBtn.disabled = !has;
        }

        function triggerDownload(dataUrl, filename) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        async function captureSequence(n) {
            if (inSequence || !stream) return;
            inSequence = true;
            capturedData = [];
            refreshThumbs();
            updatePreviewVisibility();

            for (let i = 0; i < n; i++) {
                if (countdownEl) await runCountdown();
                flash();
                const data = captureOnce();
                if (data) {
                    capturedData.push(data);
                    refreshThumbs();
                    refreshPreviewFrame();
                }
            }

            updatePreviewVisibility();
            inSequence = false;
        }

        // Frame live preview update
        function refreshPreviewFrame() {
            if (!framePhotoPreview) return;
            if (capturedData.length > 0) {
                framePhotoPreview.src = capturedData[capturedData.length - 1];
                framePhotoPreview.style.display = 'block';
            } else {
                framePhotoPreview.style.display = 'none';
            }
        }

        // Stickers
        function addSticker(emoji) {
            if (!frameBox) return;
            const el = document.createElement('div');
            el.className = 'sticker';
            el.textContent = emoji;
            el.style.position = 'absolute';
            el.style.left = '10%';
            el.style.top = '10%';
            el.style.fontSize = '42px';
            el.style.cursor = 'move';
            el.style.pointerEvents = 'auto'; // allow interaction
            el.style.userSelect = 'none';

            // append to frameBox (on top of photos)
            frameBox.appendChild(el);
            enableDragResize(el);
        }

        function enableDragResize(el) {
            let isDragging = false;
            let startX = 0, startY = 0, initLeft = 0, initTop = 0;
            let scale = 1;

            el.addEventListener('pointerdown', (ev) => {
                ev.preventDefault();
                el.setPointerCapture(ev.pointerId);
                isDragging = true;
                startX = ev.clientX;
                startY = ev.clientY;
                initLeft = parseFloat(el.style.left) || 0;
                initTop = parseFloat(el.style.top) || 0;
            });

            document.addEventListener('pointermove', (ev) => {
                if (!isDragging) return;
                const dx = ev.clientX - startX;
                const dy = ev.clientY - startY;
                el.style.left = (initLeft + dx) + 'px';
                el.style.top = (initTop + dy) + 'px';
            });

            document.addEventListener('pointerup', (ev) => {
                if (!isDragging) return;
                isDragging = false;
                try { el.releasePointerCapture(ev.pointerId); } catch (e) { }
            });

            // wheel to resize
            el.addEventListener('wheel', (e) => {
                e.preventDefault();
                scale += e.deltaY < 0 ? 0.1 : -0.1;
                scale = Math.max(0.3, Math.min(4, scale));
                el.style.transform = `scale(${scale})`;
            });

            // double-click to remove
            el.addEventListener('dblclick', () => el.remove());
        }

        // UI events (safe attach)
        startBtn && (startBtn.addEventListener('click', startCamera));
        stopBtn && (stopBtn.addEventListener('click', stopCamera));
        mirrorBtn && (mirrorBtn.addEventListener('click', () => {
            isMirrored = !isMirrored;
            if (video) {
                if (isMirrored) video.classList.add('mirror'); else video.classList.remove('mirror');
            }
            refreshThumbs();
        }));

        shutterBtn && (shutterBtn.addEventListener('click', async () => {
            if (!stream) {
                await startCamera();
                return;
            }
            if (inSequence) return;
            const n = Math.max(1, Math.min(12, parseInt(numSelect?.value || '3', 10)));
            shutterBtn.style.pointerEvents = 'none';
            shutterBtn.style.opacity = '0.85';
            await captureSequence(n);
            shutterBtn.style.pointerEvents = 'auto';
            shutterBtn.style.opacity = '1';
        }));

        let pendingAction = null;

        document.getElementById("confirmPaymentButton").addEventListener("click", async () => {
            paymentModal.hide();

            if (typeof pendingAction === "function") {
                await pendingAction();
                pendingAction = null;
            }
        });


        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        const orderIdText = document.getElementById('orderId');

        let downloadReady = false;

        function generateOrderId() {
            return "PIE-" + Math.floor(Math.random() * 999999);
        }

        downloadStripBtn && (downloadStripBtn.addEventListener('click', () => {
            orderIdText.textContent = generateOrderId();
            paymentModal.show();

            // save action to run AFTER payment confirm
            pendingAction = async () => {
                const s = await createVerticalStripFromData(capturedData);
                if (s) triggerDownload(s, `photostrip-${Date.now()}.png`);
            };
        }));


        clearBtn && (clearBtn.addEventListener('click', () => {
            capturedData = [];
            thumbContainer && (thumbContainer.innerHTML = '');
            toggleActions();
            updatePreviewVisibility();

            if (frameTextPreview) frameTextPreview.textContent = "Event Name";
            if (frameBox) {
                frameBox.style.borderColor = "#667eea";
                frameBox.style.setProperty("--frame-color", "#667eea");
            }
            frameTextValue = "";
            frameColor = "#667eea";
            refreshPreviewFrame();
        }));

        // Frame customization handlers (live preview)
        frameColorPicker && frameColorPicker.addEventListener('input', (e) => {
            frameColor = e.target.value;
            if (frameBox) frameBox.style.borderColor = frameColor;
        });

        frameText && frameText.addEventListener('input', (e) => {
            frameTextValue = e.target.value;
            if (frameTextPreview) frameTextPreview.textContent = frameTextValue.trim() || "Event Name";
        });

        filterSelect && filterSelect.addEventListener('change', (e) => {
            applyFilterToVideo(e.target.value);
        });

        fontSelect && fontSelect.addEventListener('change', (e) => {
            selectedFont = e.target.value;
            if (frameTextPreview) frameTextPreview.style.fontFamily = selectedFont;
        });

        // Sticker toolbar click (delegation)
        stickerPanel && stickerPanel.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const emoji = btn.textContent.trim();
            if (emoji) addSticker(emoji);
        });

        // cleanup
        window.addEventListener('beforeunload', () => { if (stream) stream.getTracks().forEach(t => t.stop()); });

        // initial
        updatePreviewVisibility();
        toggleActions();
        refreshPreviewFrame();

    </script>

</body>

</html>